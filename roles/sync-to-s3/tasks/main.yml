---
- name:
  block:
    - name: Sync to S3
      community.aws.s3_sync:
        access_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63316236643961343034626332396133633464383466643439383064303530363961323935613739
          6263323363393734353837356666663064373039376131620a316565653764353330343439643131
          30643561336663666662343633306338343362333030343538303932353465636263366338393731
          3639323264353839610a366332373664393062323133366165633031356237646461316234656233
          64633065613766353631306630363231623866363364373963663466316266656265
        aws_secret_access_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          37623266356232323732393939383062343564623131333732343661666438656163636539326334
          3531333531653464613534356330323666336462336435660a643433303733306463353939616633
          63323335616237383461656634373530393430663761333636663132616361383733396262643237
          3233323666306331380a396436336535656336666465383735323564636366666438643835663939
          37666634666239343634643735383064383230316433363230303766623231393164383865643964
          3835343832653230313739316430343236373630653165313431
        bucket: picnic-ncm-bucket
        key_prefix: config-backups
        file_root: /home/mattia/repos/config-backups/configuration-backup-manager/config-backups/
      register: result_s3

    - name: Add status to s3 state file
      ansible.builtin.lineinfile:
        path: templates/failed_s3.txt
        line: "S3 SYNC SUCCESSFUL"
      when: result_s3 is defined

  rescue:
    - name: Add error state to file
      ansible.builtin.lineinfile:
        path: templates/failed_s3.txt
        line: "ERROR S3 SYNC FAILED"
