---
- name:
  block:
    - name: Sync to S3
      community.aws.s3_sync:
        access_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          31623164656135366230373532613033313966613535383533313031373566353562343365343339
          6362633830306432313061303263343439383133363266330a383839666165313135323034633733
          35363666633932316638623866626538656561363735363737613336633338393432393835323431
          3831316262343433390a663462666135643465613261323237313034373063613362383830656130
          31316463653532343765363838656535323638646661373939653838646630663266
        aws_secret_access_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          35343437396233636262356366643935656138646431646330626437386566373638623635663163
          3262623538353561366136323439363834303763653362370a386632356365373639656632303662
          36316461313265623632303764383064653239373435626136643430346165636131323765363261
          3566376132336465610a633863333034353832353039616531343239363139373663376531616530
          36636630643865306631316437346237366666343839653439303965316563313237393739626539
          6638346165643731653234613032666463343833636563393130
        bucket: picnic-ncm-bucket
        key_prefix: config-backups
        file_root: /home/mattia/repos/cisco-backups/configuration-backup-manager/config-backups/
      register: result_s3

    - name: Add status to s3 state file
      ansible.builtin.lineinfile:
        path: templates/failed_s3.txt
        line: "S3 SYNC SUCCESSFUL"
      when: result_s3 is defined

  rescue:
    - name: Add error state to file
      ansible.builtin.lineinfile:
        path: templates/failed_s3.txt
        line: "ERROR S3 SYNC FAILED"
